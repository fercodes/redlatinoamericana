---
export const prerender = false; // SSR route

import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabaseClient";

// ðŸ”¹ Normalize helper (remove accents, lowercase)
const normalize = (s = "") =>
  s
    .normalize?.("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, " ")
    .trim();

// ðŸ”¹ Get topic from URL
const rawTopic = Astro.params.topic || "";
const decodedTopic = decodeURIComponent(rawTopic);
const normTopic = normalize(decodedTopic);

// ðŸ”¹ Spanish â†’ English translations
const translationsMap = {
  "geologia planetaria": ["planetary geology"],
  "geofisica": ["geophysics"],
  "geoquimica": ["geochemistry"],
  "astrobiologia": ["astrobiology"],
  "habitabilidad planetaria": ["planetary habitability"],
  "astroquimica": ["astrochemistry"],
  "astronomia": ["astronomy"],
  "astrofisica": ["astrophysics"],
  "meteoritos": ["meteorites"],
  "biologia espacial": ["space biology"],
  "atmosferas planetarias": ["planetary atmospheres"],
  "deteccion de exoplanetas": ["exoplanets"],
  "caracterizacion de exoplanetas": ["exoplanet characterization"],
  "quimica atmosferica": ["atmospheric chemistry"],
  "meteorologia y climatologia": ["meteorology"],
  "clima espacial": ["space weather"],
  "sensoriamento remoto": ["remote sensing"],
  "arquitectura espacial": ["space architecture"],
  "instrumentacion": ["instrumentation"],
  "rovers robotica cubesats nanosatelites": ["robotics", "cubesats", "nanosatellites"],
  "derecho aeroespacial": ["space law"],
  "microgravedad": ["microgravity"],
  "medicina aeroespacial": ["aerospace medicine"],
  "ingenieria aeroespacial": ["aerospace engineering"],
};

// ðŸ”¹ Build list of possible matches
const translations = translationsMap[normTopic] || [];
const candidates = [
  decodedTopic,
  normTopic,
  ...translations,
  ...translations.map((t) => normalize(t)),
];

// ðŸ”¹ Build OR filter for Supabase
const buildOrExpr = (field, terms) =>
  terms.map((t) => `${field}.ilike.%${t}%`).join(",");

let miembros = [];
let queryError = null;

try {
  const orExpr = buildOrExpr("research_interests", candidates);
  const { data, error } = await supabase
    .from("miembros") // âœ… correct table name
    .select("*")
    .or(orExpr);

  if (error) {
    console.error("Supabase error:", error);
    queryError = error;
  } else {
    miembros = data;
  }
} catch (err) {
  console.error("Unexpected error:", err);
  queryError = err;
}
---

<BaseLayout pageTitle={decodedTopic || "LÃ­nea de investigaciÃ³n"}>
  <h1>{decodedTopic || "LÃ­nea desconocida"}</h1>

  {miembros.length === 0 ? (
    <>
      <p><strong>No se encontraron miembros con este interÃ©s.</strong></p>
      {queryError ? <pre style="color:red;">Error: {String(queryError.message || queryError)}</pre> : null}
    </>
  ) : (
    <div id="miembros" class="tab-section">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Nombre completo</th>
              <th>PaÃ­s</th>
              <th>Ciudad</th>
              <th>EducaciÃ³n</th>
              <th>AfiliaciÃ³n</th>
              <th>Intereses de investigaciÃ³n</th>
              <th>Email profesional</th>
            </tr>
          </thead>
          <tbody>
            {miembros.map((person) => (
              <tr>
                <td>{person.full_name || "â€”"}</td>
                <td>{person.home_country || "â€”"}</td>
                <td>{person.city || "â€”"}</td>
                <td>{person.education || "â€”"}</td>
                <td>{person.affiliation || "â€”"}</td>
                <td>{person.research_interests || "â€”"}</td>
                <td>{person.professional_email || "â€”"}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}


  <style>
    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
    }
    th {
      background: #f4f4f4;
      text-align: left;
    }
  </style>
</BaseLayout>
