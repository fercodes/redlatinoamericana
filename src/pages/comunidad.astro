---
import BaseLayout from '../layouts/BaseLayout.astro';
const pageTitle = "Nuestra Comunidad";
import PersonCard from '../components/PersonCard.astro';
import { supabase } from '../lib/supabaseClient';

// Fetch Comite Directivo
const { data: comite, error: comiteError } = await supabase
  .from('comite_directivo')
  .select('*')
  .order('id');

// Fetch Fundadores
const { data: fundadores, error: fundadoresError } = await supabase
  .from('fundadores')
  .select('*')
  .order('id');

// Fetch Puntos Nacionales de Contacto
const { data: puntos, error: puntosError } = await supabase
  .from('puntos_nacionales_de_contacto')
  .select('*')
  .order('id');

// Fetch Asesores Internacionales
const { data: asesores, error: asesoresError } = await supabase
  .from('asesores_internacionales')
  .select('*')
  .order('full_name');

// Fetch Miembros (server-side initial render; client script will replace/update it)
const { data: miembros, error: miembrosError } = await supabase
  .from('miembros')
  .select('*')
  .in('agree_to_publish_profile', ['Yes', 'Si', 'Si/Yes', 'YES', 'Sí', 'SÍ', 'Yes/Si', 'Yes/Sí', 'Sí / Sim / Yes'])
  .order('full_name');

if (comiteError) console.error(comiteError);
if (fundadoresError) console.error(fundadoresError);
if (puntosError) console.error(puntosError);
if (asesoresError) console.error(asesoresError);
if (miembrosError) console.error(miembrosError);
---

<BaseLayout pageTitle={pageTitle}>
  <div>
    <!-- Tabs -->
    <div class="tabs">
      <button data-tab="comite" class="active">Comité Directivo</button>
      <button data-tab="fundadores">Fundadores</button>
      <button data-tab="puntos">Puntos Nacionales de Contacto</button>
      <button data-tab="asesores">Asesores Internacionales</button>
      <button data-tab="miembros">Miembros</button>
    </div>

    <!-- Tab Sections -->
    <div class="content">
      <!-- Comite Directivo -->
      <div id="comite" class="tab-section">
        <div class="grid">
          {comite?.map(person => (
            <PersonCard person={person} />
          ))}
        </div>
      </div>

      <!-- Fundadores -->
      <div id="fundadores" class="tab-section hidden">
        <div class="grid">
          {fundadores?.map(person => (
            <PersonCard person={person} />
          ))}
        </div>
      </div>

      <!-- Puntos Nacionales Table -->
      <div id="puntos" class="tab-section hidden">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre completo</th>
                <th>País</th>
                <th>Afiliación</th>
                <th>Correo</th>
              </tr>
            </thead>
            <tbody>
              {(puntos ?? []).map(person => (
                <tr>
                  <td>{person.full_name}</td>
                  <td>{person.country}</td>
                  <td>{person.affiliation}</td>
                  <td>{person.email}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Asesores Internacionales Table -->
      <div id="asesores" class="tab-section hidden">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nombre completo</th>
                <th>País</th>
                <th>Educación</th>
                <th>Afiliación</th>
                <th>Intereses de investigación</th>
                <th>Email profesional</th>
              </tr>
            </thead>
            <tbody>
              {(asesores ?? []).map(person => (
                <tr>
                  <td>{person.full_name}</td>
                  <td>{person.home_country}</td>
                  <td>{person.education}</td>
                  <td>{person.affiliation}</td>
                  <td>{person.research_interests}</td>
                  <td>{person.professional_email}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Miembros Table (initial rows rendered server-side; will be replaced/kept by client script) -->
  <div id="miembros" class="tab-section hidden">
    <div class="table-container">
      <input
        type="text"
        id="searchMiembros"
        placeholder="Buscar por nombre, país, afiliación..."
        style="margin-bottom: 1rem; padding: 0.5rem; width: 100%; max-width: 400px;"
      />
      <p id="noResults" style="display:none; margin-top:1rem;">No se encontraron resultados.</p>

      <table id="miembrosTable">
        <thead>
          <tr>
            <th>Nombre completo</th>
            <th>País</th>
            <th>Ciudad</th>
            <th>Educación</th>
            <th>Afiliación</th>
            <th>Intereses de investigación</th>
            <th>Email profesional</th>
          </tr>
        </thead>
        <tbody>
          {(miembros ?? []).map(person => (
            <tr>
              <td>{person.full_name}</td>
              <td>{person.home_country}</td>
              <td>{person.city}</td>
              <td>{person.education}</td>
              <td>{person.affiliation}</td>
              <td>{person.research_interests}</td>
              <td>{person.professional_email}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Client-side scripts: tabs + live miembros (realtime) -->
  <script type="module">
    // ----- Tabs behavior (works after DOM is loaded) -----
    document.querySelectorAll(".tabs button").forEach((btn) => {
      btn.addEventListener("click", () => {
        // Remove active class from all buttons
        document.querySelectorAll(".tabs button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        // Hide all sections
        document.querySelectorAll(".tab-section").forEach(s => s.classList.add("hidden"));

        // Show selected section
        const section = document.getElementById(btn.dataset.tab);
        if (section) section.classList.remove("hidden");
      });
    });

    // ----- Live Miembros (fetch + realtime) -----
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
    const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error('Missing PUBLIC_SUPABASE_URL or PUBLIC_SUPABASE_ANON_KEY environment variables.');
    }

    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tableBody = document.querySelector('#miembrosTable tbody');
    const searchInput = document.getElementById('searchMiembros');
    const noResults = document.getElementById('noResults');

    // Values allowed in agree_to_publish_profile (keep synchronized with server filter)
    const PUBLISH_VALUES = ['Yes','Si','Si/Yes','YES','Sí','SÍ','Yes/Si','Yes/Sí','Sí / Sim / Yes'];

    function renderRows(rows){
      // Simple safe escaping for text content
      const escape = (s) => (s === null || s === undefined) ? '' : String(s);
      tableBody.innerHTML = (rows || []).map(p => `
        <tr>
          <td>${escape(p.full_name)}</td>
          <td>${escape(p.home_country)}</td>
          <td>${escape(p.city)}</td>
          <td>${escape(p.education)}</td>
          <td>${escape(p.affiliation)}</td>
          <td>${escape(p.research_interests)}</td>
          <td>${escape(p.professional_email)}</td>
        </tr>
      `).join('');
      applyFilter(); // apply the current search query after rendering
    }

    async function loadMiembros() {
      try {
        const { data, error } = await client
          .from('miembros')
          .select('*')
          .in('agree_to_publish_profile', PUBLISH_VALUES)
          .order('full_name');

        if (error) {
          console.error('Supabase fetch error:', error);
          return;
        }

        renderRows(data || []);
      } catch (err) {
        console.error('Unexpected error loading miembros:', err);
      }
    }

    function applyFilter() {
      const value = (searchInput?.value || '').toLowerCase();
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      let visibleCount = 0;

      rows.forEach((row) => {
        const match = row.textContent.toLowerCase().includes(value);
        row.style.display = match ? '' : 'none';
        if (match) visibleCount++;
      });

      if (noResults) noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    if (searchInput) searchInput.addEventListener('input', applyFilter);

    // Subscribe to realtime changes
    function subscribeRealtime() {
      try {
        client
          .channel('public:miembros')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'miembros' }, (payload) => {
            // Simple strategy: reload the whole list on any change
            // (robust and easy to maintain)
            loadMiembros();
          })
          .subscribe();
      } catch (err) {
        console.error('Realtime subscription error:', err);
      }
    }

    // Start: load initial data and subscribe to updates
    loadMiembros();
    subscribeRealtime();
  </script>

  <style>
    /* Tabs */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .tabs button {
      padding: 0.5rem 1rem;
      border: none;
      background: #eee;
      cursor: pointer;
      border-radius: 6px;
      flex: 1 1 auto;
      min-width: 120px;
    }
    .tabs button.active {
      background: #333;
      color: white;
    }

    /* Hide tab sections */
    .tab-section.hidden {
      display: none;
    }

    /* Grid cards */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 1rem;
      padding: 1rem 0;
      justify-items: center; /* center cards horizontally */
    }

    /* Table container for horizontal scroll */
    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px; /* ensures table columns don’t get too narrow */
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
    }
    th {
      background: #f4f4f4;
      text-align: left;
    }

    /* Responsive adjustments */
    @media (max-width: 500px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
      .tabs {
        flex-direction: column;
      }
    }
  </style>
</BaseLayout>
